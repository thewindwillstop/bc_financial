# é‡‘èäº¤æ˜“å¯¹è´¦æ™ºèƒ½åˆçº¦è¯´æ˜æ–‡æ¡£

## ğŸ“‹ åˆçº¦æ¦‚è¿°

**åˆçº¦åç§°**: Reconciliation.sol
**Solidityç‰ˆæœ¬**: ^0.6.10
**æ ¸å¿ƒåŠŸèƒ½**: åŸºäº"å“ˆå¸Œç¢°æ’"çš„éšç§ä¿æŠ¤åˆ†å¸ƒå¼å¯¹è´¦ç³»ç»Ÿ

---

## ğŸ¯ æ ¸å¿ƒåˆ›æ–°ç‚¹

### 1. éšç§ä¿æŠ¤æœºåˆ¶
- **å“ˆå¸Œä¸Šé“¾**: åªä¸Šä¼  `SHA256(æµæ°´å·+é‡‘é¢+ç›)` çš„å“ˆå¸Œå€¼,ä¸å­˜å‚¨æ˜æ–‡é‡‘é¢
- **é›¶æ³„éœ²å¯¹è´¦**: åŒæ–¹ä¸Šä¼ çš„å“ˆå¸Œåœ¨é“¾ä¸Šç¢°æ’,ç›¸åŒåˆ™å¯¹è´¦æˆåŠŸ,ä¸åŒåˆ™æ•°æ®è¢«ç¯¡æ”¹

### 2. è‡ªåŠ¨åŒ–å¯¹è´¦æµç¨‹
```
æœºæ„Aä¸Šä¼  tx_001å“ˆå¸Œ â†’ å­˜å…¥åˆçº¦(çŠ¶æ€:UPLOADED)
æœºæ„Bä¸Šä¼  tx_001å“ˆå¸Œ â†’ è§¦å‘ç¢°æ’æ£€æµ‹
  â”œâ”€ Hashç›¸åŒ â†’ çŠ¶æ€:MATCHED âœ…
  â””â”€ Hashä¸åŒ â†’ çŠ¶æ€:MISMATCH âŒ
```

### 3. äº‹ä»¶é€šçŸ¥æœºåˆ¶
- `DataUploaded`: æ•°æ®ä¸Šé“¾äº‹ä»¶
- `ReconciliationEvent`: å¯¹è´¦å®Œæˆäº‹ä»¶(åŒ…å«çŠ¶æ€ã€ä¸Šä¼ æ–¹ã€å¯¹æ‰‹æ–¹ã€åŒºå—é«˜åº¦)

---

## ğŸ“Š æ•°æ®ç»“æ„

### Transaction (äº¤æ˜“è®°å½•)
```solidity
struct Transaction {
    bytes32 txHash;        // äº¤æ˜“æ•°æ®å“ˆå¸Œ
    address uploader;      // ä¸Šä¼ æœºæ„åœ°å€
    uint256 timestamp;     // ä¸Šä¼ æ—¶é—´
    TxStatus status;       // äº¤æ˜“çŠ¶æ€
    address counterparty;  // å¯¹æ‰‹æ–¹åœ°å€
    uint256 matchHeight;   // å¯¹è´¦æˆåŠŸåŒºå—é«˜åº¦
}
```

### TxStatus (äº¤æ˜“çŠ¶æ€)
- `PENDING`: å¾…ä¸Šé“¾
- `UPLOADED`: å·²ä¸Šé“¾(å•æ–¹)
- `MATCHED`: å¯¹è´¦æˆåŠŸ âœ…
- `MISMATCH`: å¯¹è´¦å¤±è´¥(æ•°æ®è¢«ç¯¡æ”¹) âŒ
- `DISPUTED`: å­˜åœ¨äº‰è®®

---

## ğŸ”§ æ ¸å¿ƒå‡½æ•°è¯´æ˜

### 1. æœºæ„ç®¡ç†

#### `registerInstitution(string name, address addr)`
æ³¨å†Œå•ä¸ªé‡‘èæœºæ„
- **æƒé™**: ä»…åˆçº¦æ‰€æœ‰è€…
- **å‚æ•°**:
  - `name`: æœºæ„åç§°(å¦‚"ä¸­å›½é“¶è¡Œ")
  - `addr`: æœºæ„åœ°å€(å»ºè®®ä½¿ç”¨ç‹¬ç«‹è´¦æˆ·)

#### `batchRegisterInstitutions(string[] names, address[] addrs)`
æ‰¹é‡æ³¨å†Œæœºæ„(éƒ¨ç½²æ—¶ä½¿ç”¨)

### 2. æ•°æ®ä¸Šé“¾

#### `uploadTransaction(bytes32 bizId, bytes32 dataHash)` â­æ ¸å¿ƒå‡½æ•°
ä¸Šä¼ äº¤æ˜“å“ˆå¸Œä¸Šé“¾,è‡ªåŠ¨è§¦å‘å¯¹è´¦
- **æƒé™**: ä»…å·²æ³¨å†Œæœºæ„
- **å‚æ•°**:
  - `bizId`: ä¸šåŠ¡æµæ°´å·(æ ¼å¼: bytes32,éœ€å‰ç«¯è½¬æ¢)
  - `dataHash`: `SHA256(æµæ°´å·+é‡‘é¢+ç›)`
- **è¿”å›å€¼**: bool (æˆåŠŸè¿”å›true,å¯¹è´¦å¤±è´¥è¿”å›false)
- **é€»è¾‘**:
  1. é¦–æ¬¡ä¸Šä¼ : åˆ›å»ºè®°å½•,çŠ¶æ€=UPLOADED
  2. äºŒæ¬¡ä¸Šä¼ : æ‰§è¡Œå“ˆå¸Œç¢°æ’
     - Hashç›¸åŒ â†’ çŠ¶æ€=MATCHED
     - Hashä¸åŒ â†’ çŠ¶æ€=MISMATCH

#### `batchUploadTransactions(bytes32[] bizIds, bytes32[] dataHashes)`
æ‰¹é‡ä¸Šä¼ äº¤æ˜“(æ€§èƒ½ä¼˜åŒ–)

### 3. æŸ¥è¯¢åŠŸèƒ½

#### `getTransaction(bytes32 bizId)`
æŸ¥è¯¢äº¤æ˜“è¯¦æƒ…

#### `getInstitution(address addr)`
æŸ¥è¯¢æœºæ„ä¿¡æ¯

#### `getStatistics()`
è·å–å…¨å±€ç»Ÿè®¡(æ€»äº¤æ˜“æ•°ã€å¯¹è´¦æˆåŠŸç‡ã€æœºæ„æ•°é‡)

#### `verifyTransaction(bytes32 bizId, bytes32 dataHash)`
å‰ç«¯"ç‚¹å‡»éªŒè¯"åŠŸèƒ½,éªŒè¯å“ˆå¸Œæ˜¯å¦åŒ¹é…

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å‰ç½®æ¡ä»¶
1. FISCO BCOSèŠ‚ç‚¹å·²å¯åŠ¨(4èŠ‚ç‚¹)
2. å·²å®‰è£…æ§åˆ¶å°å·¥å…·
3. å‡†å¤‡3-4ä¸ªæµ‹è¯•è´¦æˆ·åœ°å€

### éƒ¨ç½²æ­¥éª¤

#### æ–¹æ³•1: ä½¿ç”¨FISCOæ§åˆ¶å°(æ¨è)

```bash
# 1. å¯åŠ¨æ§åˆ¶å°
cd fisco/nodes/127.0.0.1/console
./start.sh

# 2. éƒ¨ç½²åˆçº¦
[group:1]> deploy Reconciliation.sol

# è¾“å‡ºç¤ºä¾‹:
# contract address: 0x1234...abcd

# 3. æ³¨å†Œæœºæ„
[group:1]> call Reconciliation.sol 0x1234...abcd registerInstitution "æœºæ„A" "0xAAAA..."
[group:1]> call Reconciliation.sol 0x1234...abcd registerInstitution "æœºæ„B" "0xBBBB..."

# 4. æµ‹è¯•ä¸Šä¼ 
[group:1]> call Reconciliation.sol 0x1234...abcd uploadTransaction "0x1234..." "0xabcd..."
```

#### æ–¹æ³•2: ä½¿ç”¨Go SDK(ç”Ÿäº§ç¯å¢ƒ)

å‚è€ƒåç»­æ–‡æ¡£ "Goåç«¯é›†æˆ"

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯: æœºæ„Aå’Œæœºæ„Bå¯¹è´¦

```javascript
// æ­¥éª¤1: å‰ç«¯é¢„å¤„ç†(åœ¨Goåç«¯å®ç°)
const bizId = web3.utils.keccak256("TX20260113001");  // ä¸šåŠ¡æµæ°´å·è½¬bytes32
const amount = "1000000";  // é‡‘é¢(åˆ†)
const salt = "random_salt_123";
const dataHash = web3.utils.soliditySha3(bizId, amount, salt);

// æ­¥éª¤2: æœºæ„Aä¸Šä¼ 
reconciliation.uploadTransaction(bizId, dataHash, {from: accountA});
// è§¦å‘äº‹ä»¶: DataUploaded(bizId, dataHash, accountA)

// æ­¥éª¤3: æœºæ„Bä¸Šä¼ ç›¸åŒå“ˆå¸Œ
reconciliation.uploadTransaction(bizId, dataHash, {from: accountB});
// è§¦å‘äº‹ä»¶: ReconciliationEvent(bizId, MATCHED, accountA, accountB, blockHeight)

// æ­¥éª¤4: æŸ¥è¯¢ç»“æœ
const tx = await reconciliation.getTransaction(bizId);
console.log(tx.status); // 2 (MATCHED)
```

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **è®¿é—®æ§åˆ¶**
   - `onlyOwner`: ä»…ç®¡ç†å‘˜å¯æ³¨å†Œæœºæ„
   - `onlyRegistered`: ä»…å·²æ³¨å†Œæœºæ„å¯ä¸Šä¼ æ•°æ®

2. **æ•°æ®ä¸å¯ç¯¡æ”¹**
   - æ‰€æœ‰æ•°æ®ä¸Šé“¾åä¸å¯ä¿®æ”¹
   - å“ˆå¸Œç¢°æ’å¯æ£€æµ‹æ•°æ®æ˜¯å¦è¢«ç¯¡æ”¹

3. **äº‹ä»¶æº¯æº**
   - æ¯æ¬¡æ“ä½œè§¦å‘äº‹ä»¶,å¯è¿½æº¯å®Œæ•´å†å²

---

## ğŸ“Š Gasæ¶ˆè€—ä¼°ç®—

| æ“ä½œ | Gasæ¶ˆè€— | è´¹ç”¨(1gwei) |
|------|---------|-------------|
| æ³¨å†Œæœºæ„ | ~50,000 | 0.00005 ETH |
| ä¸Šä¼ äº¤æ˜“(é¦–æ¬¡) | ~60,000 | 0.00006 ETH |
| ä¸Šä¼ äº¤æ˜“(å¯¹è´¦) | ~80,000 | 0.00008 ETH |
| æ‰¹é‡ä¸Šä¼ (100ç¬”) | ~3,000,000 | 0.003 ETH |

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹æ¸…å•

- [ ] æµ‹è¯•æœºæ„æ³¨å†Œ
- [ ] æµ‹è¯•å•ç¬”äº¤æ˜“ä¸Šä¼ 
- [ ] æµ‹è¯•å“ˆå¸Œç›¸åŒå¯¹è´¦æˆåŠŸ
- [ ] æµ‹è¯•å“ˆå¸Œä¸åŒå¯¹è´¦å¤±è´¥
- [ ] æµ‹è¯•æ‰¹é‡ä¸Šä¼ 
- [ ] æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½
- [ ] æµ‹è¯•è®¿é—®æ§åˆ¶æƒé™
- [ ] æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ä¸šåŠ¡æµæ°´å·å¤„ç†**
   - å‰ç«¯éœ€å°†å­—ç¬¦ä¸²æµæ°´å·è½¬æ¢ä¸ºbytes32
   - å»ºè®®æ ¼å¼: `keccak256("TX20260113001")`

2. **éšæœºç›ç®¡ç†**
   - æ¯ç¬”äº¤æ˜“ä½¿ç”¨ä¸åŒçš„éšæœºç›
   - ç›å€¼éœ€ä¸äº¤æ˜“æ˜æ–‡ä¸€èµ·å­˜å‚¨åœ¨é“¾ä¸‹æ•°æ®åº“

3. **åˆçº¦å‡çº§**
   - æœ¬åˆçº¦ä¸å¯å‡çº§,ä¿®æ”¹é€»è¾‘éœ€é‡æ–°éƒ¨ç½²
   - å»ºè®®ä½¿ç”¨ä»£ç†åˆçº¦æ¨¡å¼æ”¯æŒå‡çº§(é«˜çº§åŠŸèƒ½)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Solidityå®˜æ–¹æ–‡æ¡£](https://docs.soliditylang.org/)
- [FISCO BCOSæ™ºèƒ½åˆçº¦å¼€å‘æŒ‡å—](https://fisco-bcos-documentation.readthedocs.io/zh_CN/latest/docs/manual/smart_contract.html)
- [Go SDKé›†æˆæ–‡æ¡£](./Go-SDK-Integration.md) (å¾…åˆ›å»º)

---

**ä½œè€…**: æ¯•ä¸šè®¾è®¡é¡¹ç›®ç»„
**ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2026-01-13
